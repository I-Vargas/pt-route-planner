<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TrackersInfo official_recruitments</title>
  <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      #routeContainer {
        --light: hsl(0, 0%, 100%);
        --background: linear-gradient(to right bottom, hsl(0, 0%, 0%), hsl(0, 30%, 30%));
        position: relative;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        box-sizing: border-box;
        overflow: hidden;
        background: var(--background);
        user-select: none;
      }

      #calcForm {
        position: relative;
        display: flex;
        margin-top: 25px;
        align-items: center;
        color: var(--light);
        background: transparent;
        justify-content: space-between;
        padding: 10px;
      }

      #routeTitle {
        font-size: calc(max(.8vw,13px));
      }

      #routeContainer #sourceTracker,
      #routeContainer #targetTracker {
        position: relative;
        z-index: 6000;
      }

      #routeContainer #targetTracker #target,
      #routeContainer #sourceTracker #source {
        font-size: calc(max(1.25vw,14px));
        font-weight: bold;
        font-family: inherit;
        cursor: pointer;
        overflow: hidden;
        white-space: nowrap;
        color: var(--light);
        background: transparent;
        z-index: 7000;
      }

      #routeContainer #sourceTracker button,
      #routeContainer #targetTracker button{
        border: none;
        font-family: inherit;
        cursor: pointer;
      }

      #sourceAbbr, #targetAbbr {
        font-size: calc(max(1vw,13px));
      }

      #prevroute, #nextroute {
        position: relative;
        font-size: calc(max(2.5vw,32px));
        letter-spacing: 1px;
        cursor: pointer;
      }

      table {
        width: 95vw;
        max-width: 1080px;
        margin: 0 auto;
        text-align: left;
        border-collapse: collapse;
      }

      #routeTable {
        background-color: rgba(0, 0, 0, 0.2);
      }

      .table-container {
        margin-bottom: 10px;
      }

      #headerTable {
      table-layout: fixed;
      height: 100px;
      text-align: center;
      }

      .table-container {
        margin-bottom: 10px;
        
      }

      td {
//        border: 1px solid black;
        overflow: hidden;
      }
      
      .col1, .col5 {
          width: 5%;
      }
      .col2, .col4 {
          width: 20%;
      }
      .col3 {
          width: 50%;
      }

      #detailsTable {
        padding: 10px;
        margin-top: 30px;
        color: var(--light);
        font-size: 13px;
        max-height: calc(100vh - 250px);
        overflow: auto;
        line-height: 1.6;
        text-align: center;
      }

      #detailsTable td{ 
        padding: 8px;
      }

      #routeFooter {
        padding: 8px;
        color: var(--light);
        font-size: calc(max(0.8vw,13px));
        overflow: auto;
        line-height: 1.6;
        text-align: center;
      }

      #detailsTable::-webkit-scrollbar {
        width: 0;
        height: 0;
      }

      #detailsTable::-webkit-scrollbar-track {
        background: transparent;
      }

      #detailsTable::-webkit-scrollbar-thumb {
        background: transparent;
      }

      #gridContainer {
        display: none;
        position: absolute;
        width: 90vw;
        max-width: 960px;
        top: 180px;
        left: 50%;
        transform: translateX(-50%);
        max-height: 320px;
        overflow: hidden;
        font-size: 16px;
        background: #f9f9f9;
        padding: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        -ms-overflow-style: none;
        scrollbar-width: none;
        z-index: 10000;
      }

      #gridContainer::-webkit-scrollbar {
        display: none;
      }

      #gridContainer div {
        padding: 12px;
        background: #fff;
        text-align: center;
        cursor: pointer;
        white-space: nowrap;
        min-width: max-content;
      }
      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, auto));
        gap: 0px;
      }
      #gridContainer div.border {
        border: 1px solid #000;
      }

      @media (max-width: 720px) {
        .grid-container {
          grid-template-columns: repeat(auto-fit, minmax(120px, auto));
        }
      }
}
  </style>
</head>
<body>

  <form id="routeContainer" style="display: block;">

    <div id="calcForm">

    <table id="headerTable">
        <tr>
            <td class="col1"><div id="prevroute">&#8249;&#8249;</div></td>
            <td class="col2">
              <div id="sourceTracker">
                <button type="button" id="source">From</button><br>
                <div id="sourceAbbr">Any</div>
              </div>
            </td>
            <td class="col3"><div id="routeTitle"></div></td>
            <td class="col4">
              <div id="targetTracker">
                <button type="button" id="target">To</button><br>
                <div id="targetAbbr">Any</div>
              </div>
            </td>
            <td class="col5"><div id="nextroute">&#8250;&#8250;</div></td>
        </tr>
    </table>
      <div id="detailsTable"></div>
      <div id="routeFooter"></div>
    </div>
    <div id="gridContainer"></div>
  </form>

  <script>
    const dataUrl = 'data';
    async function fetchData() {
      try {
        const response = await fetch(dataUrl);
        if (!response.ok) throw new Error('Network response was not ok');
        return await response.json();
      } catch (error) {
        console.error('Error fetching data:', error);
        return null;
      }
    }

    window.addEventListener('load', async function() {
      const data = await fetchData();
      if (!data) return;

      const { routeInfo, unlockInviteClass, abbrList } = data;

      const style = document.createElement('style');
      style.textContent = `
      `;
      document.head.appendChild(style);

      const inviteForm = document.getElementById('routeContainer');

      document.getElementById('source').addEventListener('click', () => {
        toggleGrid('source');
      });

      document.getElementById('target').addEventListener('click', () => {
        toggleGrid('target');
      });

      document.getElementById('prevroute').addEventListener('click', () => {
        showRoute(-1);
      });

      document.getElementById('nextroute').addEventListener('click', () => {
        showRoute(1);
      });
      
      document.addEventListener('click', (event) => {
        const gridContainer = document.getElementById('gridContainer');
        if (gridContainer.style.display === 'block' && !gridContainer.contains(event.target) && !['source', 'target'].includes(event.target.id)) {
          gridContainer.style.display = 'none';
        }
      });
      
      let allRoutes = [];
      let currentRouteIndex = 0;

      function toggleGrid(buttonId) {
        const gridContainer = document.getElementById('gridContainer');
        if (gridContainer.style.display === 'none' || gridContainer.style.display === '') {
          populateGrid(buttonId);
          gridContainer.style.display = 'block';
        } else {
          gridContainer.style.display = 'none';
        }
      }

      function populateGrid(buttonId) {
        const gridContainer = document.getElementById('gridContainer');
        gridContainer.innerHTML = '';
        const uniqueKeys = Array.from(new Set(
          Object.keys(routeInfo)
          .flatMap(startKey => [startKey, ...Object.keys(routeInfo[startKey])])
        ))
        .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

        if (buttonId === 'source') uniqueKeys.unshift('From');
        if (buttonId === 'target') uniqueKeys.unshift('To');

        const container = document.createElement('div');
        container.className = 'grid-container';

        uniqueKeys.forEach(key => {
          const item = document.createElement('div');
          item.textContent = key;
          if (key === 'From' || key === 'To') item.classList.add('border');
          item.addEventListener('click', () => {
            if (buttonId === 'source') {
              setTextContent('source', key);
              setTextContent('sourceAbbr', key === 'From' ? 'Any' : abbrList[key] || key);
            } else {
              setTextContent('target', key);
              setTextContent('targetAbbr', key === 'To' ? 'Any' : abbrList[key] || key);
            }
            gridContainer.style.display = 'none';
            calculateRoute();
          });
          container.appendChild(item);
        });

        gridContainer.appendChild(container);
      }

      function calculateRoute() {

        const calcForm = document.getElementById('calcForm');
        const resultTitle = document.getElementById('routeTitle');
        const resultDescription = document.getElementById('detailsTable');
        const prevRouteButton = document.getElementById('prevroute');
        const nextRouteButton = document.getElementById('nextroute');
        const resultFooter = document.getElementById('routeFooter');

        resultTitle.innerText = '';
        resultDescription.innerHTML = '';
        resultFooter.innerText = '';

        const start = document.getElementById('source').textContent.trim();
        const end = document.getElementById('target').textContent.trim();

        if (start === end) {
          resultTitle.innerText = 'One account per lifetime!';
          resultDescription.innerText = '';
          calcForm.style.display = 'block';
          return;
        }

        if (start === 'From') {
          if (end === 'To') {
            resultTitle.innerText = '';
            resultDescription.innerText = '';
            calcForm.style.display = 'block';
            return;
          }
          allRoutes = Object.keys(routeInfo)
            .filter(node => routeInfo[node] && routeInfo[node][end])
            .map(node => [node, end]);
        } else if (end === 'To') {
          if (!routeInfo[start]) {
            resultTitle.innerText = 'No official recruitment';
            resultDescription.innerText = '';
            calcForm.style.display = 'block';
            return;
          }
          allRoutes = Object.keys(routeInfo[start])
            .map(node => [start, node])
            .filter(([from, to]) => routeInfo[from] && routeInfo[from][to])
            .map(([from, to]) => [from, to]);
        } else {
          if (!routeInfo[start]) {
            resultTitle.innerText = 'No official recruitment';
            resultDescription.innerText = '';
            calcForm.style.display = 'block';
            return;
          }
          allRoutes = findAllRoutes(start, end);
        }

        if (allRoutes.length === 0) {
          resultTitle.innerText = 'No results found';
          resultDescription.innerText = '';
          calcForm.style.display = 'block';
          return;
        }

        allRoutes = allRoutes.sort((a, b) => {
          const timeA = a.reduce((sum, node, index) => {
            if (index < a.length - 1 && routeInfo[node] && routeInfo[node][a[index + 1]]) {
              return sum + getMaxDays(node, a[index + 1]);
            }
            return sum;
          }, 0);

          const timeB = b.reduce((sum, node, index) => {
            if (index < b.length - 1 && routeInfo[node] && routeInfo[node][b[index + 1]]) {
              return sum + getMaxDays(node, b[index + 1]);
            }
            return sum;
          }, 0);

          return timeA - timeB;
        });

        currentRouteIndex = 0;
        showRoute(0);
      }

      function findAllRoutes(start, end) {
        const result = [];
        const stack = [[start, [start]]];
        const visited = new Set();

        while (stack.length) {
          const [node, route] = stack.pop();

          if (node === end) {
            result.push(route);
            continue;
          }

          visited.add(node);

          for (const [next, _] of Object.entries(routeInfo[node] || {})) {
            if (!route.includes(next) && !visited.has(next)) {
              stack.push([next, [...route, next]]);
            }
          }
        }

        return result;
      }

      function showRoute(direction) {
        if (allRoutes.length === 0) return;

        currentRouteIndex = (currentRouteIndex + direction + allRoutes.length) % allRoutes.length;
        const route = allRoutes[currentRouteIndex];
        const calcForm = document.getElementById('calcForm');
        const resultTitle = document.getElementById('routeTitle');
        const resultDescription = document.getElementById('detailsTable');
        const prevRouteButton = document.getElementById('prevroute');
        const nextRouteButton = document.getElementById('nextroute');
        const displayRoute = `${route.join(' -> ')}`;
        const routeTitleElement = document.getElementById('routeTitle');
        const resultFooter = document.getElementById('routeFooter');
        routeTitleElement.textContent = displayRoute;
        routeTitleElement.title = displayRoute;
        const totalRoutes = allRoutes.length;
        const routeCountText = `Route ${currentRouteIndex + 1} of ${totalRoutes}`;

        resultTitle.innerText = `${displayRoute}`;
        
        resultFooter.innerText = `${routeCountText} Total ${route.length - 2} transfer(s) ${route.reduce((sum, node, index) => {
        if (index < route.length - 1 && routeInfo[node] && routeInfo[node][route[index + 1]]) {
          return sum + getMaxDays(node, route[index + 1]);
        }
        return sum;
        }, 0)} day(s)`;
        
        const details = route.map((node, index) => {
          if (index < route.length - 1 && routeInfo[node] && routeInfo[node][route[index + 1]]) {
            const nextNode = route[index + 1];
            const maxDays = getMaxDays(node, nextNode);
            const [time, requirement, lastActivity] = routeInfo[node][nextNode];

            let tableHTML = `
              <table id="routeTable">
                <colgroup>
                  <col style="width: 220px;" />
                  <col />
                </colgroup>
                <tr>
                  <td>${node} -> ${nextNode}</td>
                  <td>${maxDays} days</td>
                </tr>
                <tr>
                  <td>Class for invite forum</td>
                  <td>${unlockInviteClass[node] ? unlockInviteClass[node][1] : ''}</td>
                </tr>
                <tr>
                  <td>Requirements</td>
                  <td>${requirement ? requirement : ''}</td>
                </tr>
                <tr>
                  <td>Last time checked</td>
                  <td>${lastActivity}</td>
                </tr>
              </table>
            `;
            return `<div class="table-container">${tableHTML}</div>`;
          }
          return '';
        }).join('');

        resultDescription.innerHTML = details;

        calcForm.style.display = 'block';
      }

      function setTextContent(id, text) {
        document.getElementById(id).textContent = text;
      }

      function getMaxDays(start, end) {
        const days1 = (routeInfo[start] && routeInfo[start][end] && routeInfo[start][end][0]) || 0;
        const days2 = (unlockInviteClass[start] && unlockInviteClass[start][0]) || 0;

        return Math.max(days1, days2);
      }
    });
  </script>
</body>
</html>
